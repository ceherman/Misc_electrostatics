!********************************************************************************
!* Complex Arithmetic
!* Numerical Recipes in FORTRAN 77 second edition, the art of scientific computing
!* by W. H. Press, S. A. Teukolsky, W. T. Vetterling and B. P. Flannery
!* Cambridge University Press, 1997
!********************************************************************************

    PURE FUNCTION zmodulus(ztp1)

        COMPLEX(KIND=KIND(1.0D0)), intent(in) :: ztp1
        DOUBLE PRECISION :: zmodulus

        DOUBLE PRECISION :: tpa, tpb, tpc, tpd, tp1, tp2, tp3, tp4

        tpa = REALPART(ztp1)
        tpb = IMAGPART(ztp1)

        tp1 = DABS(tpa)
        tp2 = DABS(tpb)

        IF (tp1 >= tp2) THEN

            tp3 = tpb/tpa
            tp4 = DSQRT(1.0d0 + tp3*tp3)

            zmodulus = tp1 * tp4


        ELSE

            tp3 = tpa/tpb
            tp4 = DSQRT(1.0d0 + tp3*tp3)

            zmodulus = tp2 * tp4

        END IF

    END FUNCTION

    PURE FUNCTION zadder(ztp1,ztp2)

        COMPLEX(KIND=KIND(1.0D0)), intent(in) :: ztp1,ztp2
        COMPLEX(KIND=KIND(1.0D0)) :: zadder

        DOUBLE PRECISION :: tpa, tpb, tpc, tpd, tp1, tp2, tp3, tp4

        tpa = REALPART(ztp1)
        tpb = IMAGPART(ztp1)

        tpc = REALPART(ztp2)
        tpd = IMAGPART(ztp2)

        tp1 = tpa + tpc
        tp2 = tpb + tpd

        zadder = DCMPLX(tp1, tp2)

    END FUNCTION

    PURE FUNCTION zsubtractor(ztp1,ztp2)

        COMPLEX(KIND=KIND(1.0D0)), intent(in) :: ztp1,ztp2
        COMPLEX(KIND=KIND(1.0D0)) :: zsubtractor

        DOUBLE PRECISION :: tpa, tpb, tpc, tpd, tp1, tp2, tp3, tp4

        tpa = REALPART(ztp1)
        tpb = IMAGPART(ztp1)

        tpc = REALPART(ztp2)
        tpd = IMAGPART(ztp2)

        tp1 = tpa - tpc
        tp2 = tpb - tpd

        zsubtractor = DCMPLX(tp1, tp2)

    END FUNCTION

    PURE FUNCTION zmultiplier(ztp1,ztp2)

        COMPLEX(KIND=KIND(1.0D0)), intent(in) :: ztp1,ztp2
        COMPLEX(KIND=KIND(1.0D0)) :: zmultiplier

        DOUBLE PRECISION :: tpa, tpb, tpc, tpd, tp1, tp2, tp3, tp4

        tpa = REALPART(ztp1)
        tpb = IMAGPART(ztp1)

        tpc = REALPART(ztp2)
        tpd = IMAGPART(ztp2)

        tp1 = tpa*tpc
        tp2 = tpb*tpd
        tp3 = (tpa+tpb)*(tpc+tpd)

        tp4 = tp1-tp2
        tp3 = tp3-tp1-tp2

        zmultiplier = DCMPLX(tp4, tp3)

    END FUNCTION

    PURE FUNCTION zdivider(ztp1,ztp2)

        COMPLEX(KIND=KIND(1.0D0)), intent(in) :: ztp1,ztp2
        COMPLEX(KIND=KIND(1.0D0)) :: zdivider

        DOUBLE PRECISION :: tpa, tpb, tpc, tpd, tp1, tp2, tp3, tp4

        tpa = REALPART(ztp1)
        tpb = IMAGPART(ztp1)

        tpc = REALPART(ztp2)
        tpd = IMAGPART(ztp2)

        IF (DABS(tpc) >= DABS(tpd)) THEN

            tp1 = tpd/tpc

            tp4 = 1.0d0/(tpc + tpd*tp1)

            tp2 = (tpa + tpb*tp1)*tp4
            tp3 = (tpb - tpa*tp1)*tp4

            zdivider = DCMPLX(tp2, tp3)

        ELSE

            tp1 = tpc/tpd

            tp4 = 1.0d0/(tpc*tp1 + tpd)

            tp2 = (tpa*tp1 + tpb)*tp4
            tp3 = (tpb*tp1 - tpa)*tp4

            zdivider = DCMPLX(tp2, tp3)

        END IF

    END FUNCTION

    PURE FUNCTION zsquareroot(ztp1)

        COMPLEX(KIND=KIND(1.0D0)), intent(in) :: ztp1
        COMPLEX(KIND=KIND(1.0D0)) :: zsquareroot

        DOUBLE PRECISION :: tpa, tpb, tpc, tpd, tpw, tp1, tp2, tp3, tp4

        tpc = REALPART(ztp1)
        tpd = IMAGPART(ztp1)

        tpa = DABS(tpc)
        tpb = DABS(tpd)

        IF (tpa == 0.0d0 .AND. tpb == 0.0d0) THEN

            tpw = 0.0d0

        ELSE

            IF (tpa >= tpb) THEN

                tp1 = tpb/tpa

                tp2 = DSQRT(1.0d0 + tp1*tp1)
                tp3 = DSQRT(tpa * (1.0d0 + tp2) * 0.5d0)
                tpw = tp3

            ELSE

                tp1 = tpa/tpb

                tp2 = DSQRT(1.0d0 + tp1*tp1)
                tp3 = DSQRT(tpb * (tp1 + tp2) * 0.5d0)
                tpw = tp3

            END IF

        END IF

        IF (tpw == 0.0d0) THEN

            zsquareroot = DCMPLX(0.0d0, 0.0d0)

        ELSE

            IF (tpc >= 0.0d0) THEN

                tp1 = tpd/(2.0d0 * tpw)

                zsquareroot = DCMPLX(tpw, tp1)

            ELSE

                IF (tpd >= 0.0d0) THEN

                    tp1 = tpb/(2.0d0 * tpw)

                    zsquareroot = DCMPLX(tp1, tpw)

                ELSE

                    tp1 = tpb/(2.0d0 * tpw)

                    zsquareroot = DCMPLX(tp1,-tpw)

                END IF

            END IF

        END IF

    END FUNCTION

    PURE FUNCTION zdexp(ztp1)

        COMPLEX(KIND=KIND(1.0D0)), intent(in) :: ztp1
        COMPLEX(KIND=KIND(1.0D0)) :: zdexp

        DOUBLE PRECISION :: tpa, tpb, tpc, tpd, tpw, tp1, tp2, tp3, tp4

        tpa = REALPART(ztp1)
        tpb = IMAGPART(ztp1)

        tp1 = DCOS(tpb)
        tp2 = DSIN(tpb)

        tp3 = DEXP(tpa)

        tp1 = tp3*tp1
        tp2 = tp3*tp2

        zdexp = DCMPLX(tp1, tp2)

    END FUNCTION

!********************************************************************************
!* Calculation of GAUSS-LEGENDRE abscissas and weights for Gaussian Quadrature
!* integration of polynomial functions.
!*      For normalized lower and upper limits of integration -1.0 & 1.0, and
!* given n, this routine calculates, arrays xabsc(1:n) and  weig(1:n) of length n,
!* containing the abscissas and weights of the Gauss-Legendre n-point quadrature
!* formula.  For detailed explanations finding weights & abscissas, see
!* "Numerical Recipes in Fortran */
!********************************************************************************
    SUBROUTINE  GauLegCoeff1D(dmngp, dmxabsc, dmweig)

        IMPLICIT NONE
        INTEGER ::  i, j, m
        DOUBLE PRECISION :: p1, p2, p3, pp, z, z1
        INTEGER, INTENT(IN) :: dmngp            ! # of Gauss Points
        DOUBLE PRECISION, INTENT(OUT) :: dmxabsc(dmngp), dmweig(dmngp)
        DOUBLE PRECISION, PARAMETER  :: pai_GL = DATAN(1.0d0)*4.0d0
        DOUBLE PRECISION, PARAMETER  :: EPS_GL=3.0d-15

        m = (dmngp + 1) / 2
!* Roots are symmetric in the interval - so only need to find half of them  */

        DO i = 1, m             ! Loop over the desired roots */

            z = DCOS( pai_GL * (DBLE(i)-0.25d0) / (DBLE(dmngp)+0.5d0) )
!*   Starting with the above approximation to the ith root,
!*          we enter the main loop of refinement by NEWTON'S method   */
100         p1 = 1.0d0
            p2 = 0.0d0
!*  Loop up the recurrence relation to get the Legendre
!*  polynomial evaluated at z                 */

            DO j = 1, dmngp
                p3 = p2
                p2 = p1
                p1 = ((2.0d0*DBLE(j)-1.0d0) * z * p2 - (DBLE(j)-1.0d0)*p3) / DBLE(j)
            END DO

!* p1 is now the desired Legendre polynomial. We next compute pp,
!* its derivative, by a standard relation involving also p2, the
!* polynomial of one lower order.      */
            pp = dmngp*(z*p1-p2)/(z*z-1.0d0)
            z1 = z
            z = z1 - p1/pp             ! Newton's Method  */

            IF (DABS(z-z1) .gt. EPS_GL) GOTO  100

            dmxabsc(i) =  - z                       ! Roots will be bewteen -1.0 & 1.0 */
            dmxabsc(dmngp+1-i) =  + z               ! and symmetric about the origin   */
            dmweig(i) = 2.0d0/((1.0d0-z*z)*pp*pp)   ! Compute the weight and its       */
            dmweig(dmngp+1-i) = dmweig(i)           ! symmetric counterpart            */

        END DO     ! i loop

    END SUBROUTINE GauLegCoeff1D

!********************************************************************************
!* Calculation of GAUSS-LEGENDRE abscissas and weights for Gaussian Quadrature
!* over a triangular surface.
!*      For a unit right triangle surface
!* given n, this routine calculates, arrays xabsc(1:n**2) yabsc(1:n**2) and  weig(1:n**2)
!* of length n, containing the abscissas and weights.
!* Details see "Rathod etal_
!* Symmetric Gauss Legendre quadrature formulas over a triangular surface_AMC188(2007)865
!********************************************************************************
    SUBROUTINE  GauLegTriCoeff2D(dmngp, dmxabsc, dmyabsc, dmweig)

        IMPLICIT NONE
        INTEGER ::  i, j, m, r
        DOUBLE PRECISION, ALLOCATABLE, DIMENSION (:) :: zetai,weitzi,etaj,weitej
        INTEGER, INTENT(IN) :: dmngp
        DOUBLE PRECISION, INTENT(OUT) ::  dmxabsc(dmngp*dmngp), &
                                        & dmyabsc(dmngp*dmngp), &
                                        & dmweig(dmngp*dmngp)

        ALLOCATE (zetai(dmngp))
        ALLOCATE (weitzi(dmngp))
        CALL GauLegCoeff1D(dmngp,zetai,weitzi)

        ALLOCATE (etaj(dmngp))
        ALLOCATE (weitej(dmngp))
        CALL GauLegCoeff1D(dmngp,etaj,weitej)

        r = 1

        DO i = 1, dmngp

            DO j = 1, dmngp

                dmweig(r) = (1.0d0+zetai(i))/8.0d0*weitzi(i)*weitej(j)
                dmxabsc(r) = (1.0d0+zetai(i))*(1.0d0+etaj(j))/4.0d0
                dmyabsc(r) = (1.0d0+zetai(i))*(1.0d0-etaj(j))/4.0d0

                r = r + 1

            END DO

        END DO

!       OPEN (UNIT = 111, FILE='2DGauLegTri.csv', STATUS="REPLACE")
!       WRITE (111, *)'ID,x,y,w'
!       DO i = 1, dmngp*dmngp
!           WRITE (111, '(I4,A,F12.6,A,F12.6,A,F12.6)') &
!               &i,',',dmxabsc(i),',',dmyabsc(i),',',dmweig(i)
!       END DO
!       CLOSE (111)

        DEALLOCATE (zetai, weitzi)
        DEALLOCATE (etaj, weitej)

    END SUBROUTINE GauLegTriCoeff2D


!********************************************************************************
!* Calculation of GAUSS-LEGENDRE abscissas and weights for Gaussian Quadrature
!* over a triangular surface.
!*      For a unit right triangle surface
!* All results are copied and interpolated from
!* Witherden Vincent_symmetric quadrature rules_CMA69(2015)1232
!* The interpolation makes original (-1,1) to (0,1) by (x+1)/2, (y+1)/2
!* Note by doing so, the weight is scaled by 0.25 or 1/4
!* We only list 12, 16 and 25 nodes for the degree of precision up to 10 (6, 8)
!********************************************************************************
    SUBROUTINE  GauLegUniTriCff2D(dmngp, dmxabsc, dmyabsc, dmweig)

        IMPLICIT NONE

        INTEGER, INTENT(IN) :: dmngp
        DOUBLE PRECISION, INTENT(OUT) ::  dmxabsc(dmngp), &
                                        & dmyabsc(dmngp), &
                                        & dmweig(dmngp)
        DOUBLE PRECISION :: wg_12(12),xg_12(12),yg_12(12),wg_16(16),xg_16(16),yg_16(16), &
        &                   wg_25(25),xg_25(25),yg_25(25),wg_49(49),xg_49(49),yg_49(49)

        wg_12 = (/ &
        &        0.02542245318510340846046840455343d0, &
        &        0.02542245318510340846046840455343d0, &
        &        0.02542245318510340846046840455343d0, &
        &        0.05839313786318968301264480569279d0, &
        &        0.05839313786318968301264480569279d0, &
        &        0.05839313786318968301264480569279d0, &
        &        0.04142553780918678759677672821022d0, &
        &        0.04142553780918678759677672821022d0, &
        &        0.04142553780918678759677672821022d0, &
        &        0.04142553780918678759677672821022d0, &
        &        0.04142553780918678759677672821022d0, &
        &        0.04142553780918678759677672821022d0 /)
        xg_12 = (/ &
        &        0.06308901449150222834033160287082d0, &
        &        0.87382197101699554331933679425836d0, &
        &        0.06308901449150222834033160287082d0, &
        &        0.24928674517091042129163855310702d0, &
        &        0.50142650965817915741672289378596d0, &
        &        0.24928674517091042129163855310702d0, &
        &        0.05314504984481694735324967163140d0, &
        &        0.63650249912139864723014259441205d0, &
        &        0.31035245103378440541660773395655d0, &
        &        0.63650249912139864723014259441205d0, &
        &        0.31035245103378440541660773395655d0, &
        &        0.05314504984481694735324967163140d0 /)
        yg_12 = (/ &
        &        0.87382197101699554331933679425836d0, &
        &        0.06308901449150222834033160287082d0, &
        &        0.06308901449150222834033160287082d0, &
        &        0.50142650965817915741672289378596d0, &
        &        0.24928674517091042129163855310702d0, &
        &        0.24928674517091042129163855310702d0, &
        &        0.63650249912139864723014259441205d0, &
        &        0.05314504984481694735324967163140d0, &
        &        0.63650249912139864723014259441205d0, &
        &        0.31035245103378440541660773395655d0, &
        &        0.05314504984481694735324967163140d0, &
        &        0.31035245103378440541660773395655d0 /)

        wg_16 = (/ &
        &        0.07215780383889358412554555524453d0, &
        &        0.04754581713364231239694805219429d0, &
        &        0.04754581713364231239694805219429d0, &
        &        0.04754581713364231239694805219429d0, &
        &        0.05160868526735912514089577514606d0, &
        &        0.05160868526735912514089577514606d0, &
        &        0.05160868526735912514089577514606d0, &
        &        0.01622924881159904015546296417089d0, &
        &        0.01622924881159904015546296417089d0, &
        &        0.01622924881159904015546296417089d0, &
        &        0.01361515708721749713242234503695d0, &
        &        0.01361515708721749713242234503695d0, &
        &        0.01361515708721749713242234503695d0, &
        &        0.01361515708721749713242234503695d0, &
        &        0.01361515708721749713242234503695d0, &
        &        0.01361515708721749713242234503695d0 /)
        xg_16 = (/ &
        &        0.33333333333333333333333333333333d0, &
        &        0.45929258829272315602881551449417d0, &
        &        0.08141482341455368794236897101166d0, &
        &        0.45929258829272315602881551449417d0, &
        &        0.17056930775176020662229350149146d0, &
        &        0.65886138449647958675541299701707d0, &
        &        0.17056930775176020662229350149146d0, &
        &        0.05054722831703097545842355059660d0, &
        &        0.89890554336593804908315289880680d0, &
        &        0.05054722831703097545842355059660d0, &
        &        0.00839477740995760533721383453929d0, &
        &        0.72849239295540428124100037917606d0, &
        &        0.26311282963463811342178578628464d0, &
        &        0.72849239295540428124100037917606d0, &
        &        0.26311282963463811342178578628464d0, &
        &        0.00839477740995760533721383453929d0 /)
        yg_16 = (/ &
        &        0.33333333333333333333333333333333d0, &
        &        0.08141482341455368794236897101166d0, &
        &        0.45929258829272315602881551449417d0, &
        &        0.45929258829272315602881551449417d0, &
        &        0.65886138449647958675541299701707d0, &
        &        0.17056930775176020662229350149146d0, &
        &        0.17056930775176020662229350149146d0, &
        &        0.89890554336593804908315289880680d0, &
        &        0.05054722831703097545842355059660d0, &
        &        0.05054722831703097545842355059660d0, &
        &        0.72849239295540428124100037917606d0, &
        &        0.00839477740995760533721383453929d0, &
        &        0.72849239295540428124100037917606d0, &
        &        0.26311282963463811342178578628464d0, &
        &        0.00839477740995760533721383453929d0, &
        &        0.26311282963463811342178578628464d0 /)

        wg_25 = (/ &
        &        0.04087166457314298321405934249209d0, &
        &        0.00667648440657478313778648919953d0, &
        &        0.00667648440657478313778648919953d0, &
        &        0.00667648440657478313778648919953d0, &
        &        0.02297898180237236400689395481627d0, &
        &        0.02297898180237236400689395481627d0, &
        &        0.02297898180237236400689395481627d0, &
        &        0.03195245319821202271644936688133d0, &
        &        0.03195245319821202271644936688133d0, &
        &        0.03195245319821202271644936688133d0, &
        &        0.03195245319821202271644936688133d0, &
        &        0.03195245319821202271644936688133d0, &
        &        0.03195245319821202271644936688133d0, &
        &        0.01709232408147971431434579202067d0, &
        &        0.01709232408147971431434579202067d0, &
        &        0.01709232408147971431434579202067d0, &
        &        0.01709232408147971431434579202067d0, &
        &        0.01709232408147971431434579202067d0, &
        &        0.01709232408147971431434579202067d0, &
        &        0.01264887885364419219452139534142d0, &
        &        0.01264887885364419219452139534142d0, &
        &        0.01264887885364419219452139534142d0, &
        &        0.01264887885364419219452139534142d0, &
        &        0.01264887885364419219452139534142d0, &
        &        0.01264887885364419219452139534142d0 /)
        xg_25 = (/ &
        &        0.33333333333333333333333333333333d0, &
        &        0.03205537321694351293098458933649d0, &
        &        0.93588925356611297413803082132702d0, &
        &        0.03205537321694351293098458933649d0, &
        &        0.14216110105656438509216210319096d0, &
        &        0.71567779788687122981567579361808d0, &
        &        0.14216110105656438509216210319096d0, &
        &        0.32181299528883542122509756098605d0, &
        &        0.53005411892734402827709567394569d0, &
        &        0.14813288578382055049780676506826d0, &
        &        0.53005411892734402827709567394569d0, &
        &        0.14813288578382055049780676506826d0, &
        &        0.32181299528883542122509756098605d0, &
        &        0.02961988948872976763383626942604d0, &
        &        0.60123332868345924545474289345869d0, &
        &        0.36914678182781098691142083711527d0, &
        &        0.60123332868345924545474289345869d0, &
        &        0.36914678182781098691142083711527d0, &
        &        0.02961988948872976763383626942604d0, &
        &        0.02836766533993843925043575557813d0, &
        &        0.80793060092287906507994990288174d0, &
        &        0.16370173373718249566961434154013d0, &
        &        0.80793060092287906507994990288174d0, &
        &        0.16370173373718249566961434154013d0, &
        &        0.02836766533993843925043575557813d0 /)
        yg_25 = (/ &
        &        0.33333333333333333333333333333333d0, &
        &        0.93588925356611297413803082132702d0, &
        &        0.03205537321694351293098458933649d0, &
        &        0.03205537321694351293098458933649d0, &
        &        0.71567779788687122981567579361808d0, &
        &        0.14216110105656438509216210319096d0, &
        &        0.14216110105656438509216210319096d0, &
        &        0.53005411892734402827709567394569d0, &
        &        0.32181299528883542122509756098605d0, &
        &        0.53005411892734402827709567394569d0, &
        &        0.14813288578382055049780676506826d0, &
        &        0.32181299528883542122509756098605d0, &
        &        0.14813288578382055049780676506826d0, &
        &        0.60123332868345924545474289345869d0, &
        &        0.02961988948872976763383626942604d0, &
        &        0.60123332868345924545474289345869d0, &
        &        0.36914678182781098691142083711527d0, &
        &        0.02961988948872976763383626942604d0, &
        &        0.36914678182781098691142083711527d0, &
        &        0.80793060092287906507994990288174d0, &
        &        0.02836766533993843925043575557813d0, &
        &        0.80793060092287906507994990288174d0, &
        &        0.16370173373718249566961434154013d0, &
        &        0.02836766533993843925043575557813d0, &
        &        0.16370173373718249566961434154013d0 /)

        wg_49 = (/ &
        &        0.02216769369109203769379967032852d0, &
        &        0.02135689078573028352068145968642d0, &
        &        0.02135689078573028352068145968642d0, &
        &        0.02135689078573028352068145968642d0, &
        &        0.00822236878131258188434000434425d0, &
        &        0.00822236878131258188434000434425d0, &
        &        0.00822236878131258188434000434425d0, &
        &        0.00869807400038170727886327544213d0, &
        &        0.00869807400038170727886327544213d0, &
        &        0.00869807400038170727886327544213d0, &
        &        0.02339168086435481617813444739039d0, &
        &        0.02339168086435481617813444739039d0, &
        &        0.02339168086435481617813444739039d0, &
        &        0.00478692309123004310328462681330d0, &
        &        0.00478692309123004310328462681330d0, &
        &        0.00478692309123004310328462681330d0, &
        &        0.00148038731895268778463815131918d0, &
        &        0.00148038731895268778463815131918d0, &
        &        0.00148038731895268778463815131918d0, &
        &        0.00780128641528798237588745791425d0, &
        &        0.00780128641528798237588745791425d0, &
        &        0.00780128641528798237588745791425d0, &
        &        0.00780128641528798237588745791425d0, &
        &        0.00780128641528798237588745791425d0, &
        &        0.00780128641528798237588745791425d0, &
        &        0.00201492668600904980918216745543d0, &
        &        0.00201492668600904980918216745543d0, &
        &        0.00201492668600904980918216745543d0, &
        &        0.00201492668600904980918216745543d0, &
        &        0.00201492668600904980918216745543d0, &
        &        0.00201492668600904980918216745543d0, &
        &        0.01436029346260067011533282083583d0, &
        &        0.01436029346260067011533282083583d0, &
        &        0.01436029346260067011533282083583d0, &
        &        0.01436029346260067011533282083583d0, &
        &        0.01436029346260067011533282083583d0, &
        &        0.01436029346260067011533282083583d0, &
        &        0.00583631059078792266978850277217d0, &
        &        0.00583631059078792266978850277217d0, &
        &        0.00583631059078792266978850277217d0, &
        &        0.00583631059078792266978850277217d0, &
        &        0.00583631059078792266978850277217d0, &
        &        0.00583631059078792266978850277217d0, &
        &        0.01565773814248464220587145680308d0, &
        &        0.01565773814248464220587145680308d0, &
        &        0.01565773814248464220587145680308d0, &
        &        0.01565773814248464220587145680308d0, &
        &        0.01565773814248464220587145680308d0, &
        &        0.01565773814248464220587145680308d0 /)
        xg_49 = (/ &
        &        0.33333333333333333333333333333333d0, &
        &        0.40536221413397547786675611071975d0, &
        &        0.18927557173204904426648777856050d0, &
        &        0.40536221413397547786675611071975d0, &
        &        0.07017355289998601748435975214343d0, &
        &        0.85965289420002796503128049571314d0, &
        &        0.07017355289998601748435975214343d0, &
        &        0.47417068143801979197869069527411d0, &
        &        0.05165863712396041604261860945179d0, &
        &        0.47417068143801979197869069527411d0, &
        &        0.22637871342034959829072558108462d0, &
        &        0.54724257315930080341854883783076d0, &
        &        0.22637871342034959829072558108462d0, &
        &        0.49499695676912618423779964768391d0, &
        &        0.01000608646174763152440070463218d0, &
        &        0.49499695676912618423779964768391d0, &
        &        0.01581172625098864555895173378387d0, &
        &        0.96837654749802270888209653243226d0, &
        &        0.01581172625098864555895173378387d0, &
        &        0.01837611238568109196104439558140d0, &
        &        0.66697564480186808994632353920371d0, &
        &        0.31464824281245081809263206521489d0, &
        &        0.66697564480186808994632353920371d0, &
        &        0.31464824281245081809263206521489d0, &
        &        0.01837611238568109196104439558140d0, &
        &        0.00913923703730839503655181749099d0, &
        &        0.91991215772623606490286059529679d0, &
        &        0.07094860523645554006058758721222d0, &
        &        0.91991215772623606490286059529679d0, &
        &        0.07094860523645554006058758721222d0, &
        &        0.00913923703730839503655181749099d0, &
        &        0.19053558947639393343069024968596d0, &
        &        0.71522235693145070188397936878373d0, &
        &        0.09424205359215536468533038153031d0, &
        &        0.71522235693145070188397936878373d0, &
        &        0.09424205359215536468533038153031d0, &
        &        0.19053558947639393343069024968596d0, &
        &        0.16806864522241435546477758858363d0, &
        &        0.81329264104941926991225831301336d0, &
        &        0.01863871372816637462296409840301d0, &
        &        0.81329264104941926991225831301336d0, &
        &        0.01863871372816637462296409840301d0, &
        &        0.16806864522241435546477758858363d0, &
        &        0.33895061147527718921459300467045d0, &
        &        0.56525266487711421445185193436676d0, &
        &        0.09579672364760859633355506096279d0, &
        &        0.56525266487711421445185193436676d0, &
        &        0.09579672364760859633355506096279d0, &
        &        0.33895061147527718921459300467045d0 /)
        yg_49 = (/ &
        &        0.33333333333333333333333333333333d0, &
        &        0.18927557173204904426648777856050d0, &
        &        0.40536221413397547786675611071975d0, &
        &        0.40536221413397547786675611071975d0, &
        &        0.85965289420002796503128049571314d0, &
        &        0.07017355289998601748435975214343d0, &
        &        0.07017355289998601748435975214343d0, &
        &        0.05165863712396041604261860945179d0, &
        &        0.47417068143801979197869069527411d0, &
        &        0.47417068143801979197869069527411d0, &
        &        0.54724257315930080341854883783076d0, &
        &        0.22637871342034959829072558108462d0, &
        &        0.22637871342034959829072558108462d0, &
        &        0.01000608646174763152440070463218d0, &
        &        0.49499695676912618423779964768391d0, &
        &        0.49499695676912618423779964768391d0, &
        &        0.96837654749802270888209653243226d0, &
        &        0.01581172625098864555895173378387d0, &
        &        0.01581172625098864555895173378387d0, &
        &        0.66697564480186808994632353920371d0, &
        &        0.01837611238568109196104439558140d0, &
        &        0.66697564480186808994632353920371d0, &
        &        0.31464824281245081809263206521489d0, &
        &        0.01837611238568109196104439558140d0, &
        &        0.31464824281245081809263206521489d0, &
        &        0.91991215772623606490286059529679d0, &
        &        0.00913923703730839503655181749099d0, &
        &        0.91991215772623606490286059529679d0, &
        &        0.07094860523645554006058758721222d0, &
        &        0.00913923703730839503655181749099d0, &
        &        0.07094860523645554006058758721222d0, &
        &        0.71522235693145070188397936878373d0, &
        &        0.19053558947639393343069024968596d0, &
        &        0.71522235693145070188397936878373d0, &
        &        0.09424205359215536468533038153031d0, &
        &        0.19053558947639393343069024968596d0, &
        &        0.09424205359215536468533038153031d0, &
        &        0.81329264104941926991225831301336d0, &
        &        0.16806864522241435546477758858363d0, &
        &        0.81329264104941926991225831301336d0, &
        &        0.01863871372816637462296409840301d0, &
        &        0.16806864522241435546477758858363d0, &
        &        0.01863871372816637462296409840301d0, &
        &        0.56525266487711421445185193436676d0, &
        &        0.33895061147527718921459300467045d0, &
        &        0.56525266487711421445185193436676d0, &
        &        0.09579672364760859633355506096279d0, &
        &        0.33895061147527718921459300467045d0, &
        &        0.09579672364760859633355506096279d0 /)


        IF (dmngp == 12) THEN
            dmxabsc = xg_12
            dmyabsc = yg_12
            dmweig  = wg_12
        END IF

        IF (dmngp == 16) THEN
            dmxabsc = xg_16
            dmyabsc = yg_16
            dmweig  = wg_16
        END IF

        IF (dmngp == 25) THEN
            dmxabsc = xg_25
            dmyabsc = yg_25
            dmweig  = wg_25
        END IF

        IF (dmngp == 49) THEN
            dmxabsc = xg_49
            dmyabsc = yg_49
            dmweig  = wg_49
        END IF

    END SUBROUTINE GauLegUniTriCff2D

!********************************************************************************
!* Calculation of GAUSS-LEGENDRE abscissas and weights for Gaussian Quadrature
!* over a tetrahedron volume.
!*      For a unit right tetrahedron volume
!* All results are copied and interpolated from
!* Witherden Vincent_symmetric quadrature rules_CMA69(2015)1232
!* The interpolation makes original (-1,1) to (0,1) by (x+1)/2, (y+1)/2, (z+1)/2
!* Note by doing so, the weight is scaled by 0.125 or 1/8
!* We only list 24 and 46 for the degree of precision to 6 or 8
!********************************************************************************
    SUBROUTINE  GauLegUniTetCff3D(dmngp, dmxabsc, dmyabsc, dmzabsc, dmweig)

        IMPLICIT NONE

        INTEGER, INTENT(IN) :: dmngp
        DOUBLE PRECISION, INTENT(OUT) ::  dmxabsc(dmngp), &
                                        & dmyabsc(dmngp), &
                                        & dmzabsc(dmngp), &
                                        & dmweig(dmngp)
        DOUBLE PRECISION :: wg_24(24),xg_24(24),yg_24(24),zg_24(24), &
        &                   wg_46(46),xg_46(46),yg_46(46),zg_46(46)

        wg_24 = (/ &
        &        1.67953517588677382466887290765614385d-3, &
        &        1.67953517588677382466887290765614385d-3, &
        &        1.67953517588677382466887290765614385d-3, &
        &        1.67953517588677382466887290765614385d-3, &
        &        9.22619692394245368252554630895433610d-3, &
        &        9.22619692394245368252554630895433610d-3, &
        &        9.22619692394245368252554630895433610d-3, &
        &        9.22619692394245368252554630895433610d-3, &
        &        6.65379170969458201661510459291332982d-3, &
        &        6.65379170969458201661510459291332982d-3, &
        &        6.65379170969458201661510459291332982d-3, &
        &        6.65379170969458201661510459291332982d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3, &
        &        8.03571428571428571428571428571428503d-3 /)
        xg_24 = (/ &
        &        4.06739585346113531155794489564100469d-2, &
        &        4.06739585346113531155794489564100469d-2, &
        &        0.877978124396165940653261653130769811d0, &
        &        4.06739585346113531155794489564100469d-2, &
        &        0.322337890142275510343994470762492129d0, &
        &        0.322337890142275510343994470762492129d0, &
        &        3.29863295731734689680165877125236123d-2, &
        &        0.322337890142275510343994470762492129d0, &
        &        0.214602871259152029288839219386285011d0, &
        &        0.214602871259152029288839219386285011d0, &
        &        0.356191386222543912133482341841145015d0, &
        &        0.214602871259152029288839219386285011d0, &
        &        0.603005664791649141367431139060939661d0, &
        &        0.603005664791649141367431139060939661d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.269672331458315808034097805727606344d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.269672331458315808034097805727606344d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        6.36610018750175252992355276057269734d-2, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.269672331458315808034097805727606344d0, &
        &        0.603005664791649141367431139060939661d0 /)
        yg_24 = (/ &
        &        4.06739585346113531155794489564100469d-2, &
        &        0.877978124396165940653261653130769811d0, &
        &        4.06739585346113531155794489564100469d-2, &
        &        4.06739585346113531155794489564100469d-2, &
        &        0.322337890142275510343994470762492129d0, &
        &        3.29863295731734689680165877125236123d-2, &
        &        0.322337890142275510343994470762492129d0, &
        &        0.322337890142275510343994470762492129d0, &
        &        0.214602871259152029288839219386285011d0, &
        &        0.356191386222543912133482341841145015d0, &
        &        0.214602871259152029288839219386285011d0, &
        &        0.214602871259152029288839219386285011d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        6.36610018750175252992355276057269734d-2, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.603005664791649141367431139060939661d0, &
        &        0.269672331458315808034097805727606344d0, &
        &        0.603005664791649141367431139060939661d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.269672331458315808034097805727606344d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.603005664791649141367431139060939661d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.269672331458315808034097805727606344d0 /)
        zg_24 = (/ &
        &        0.877978124396165940653261653130769811d0, &
        &        4.06739585346113531155794489564100469d-2, &
        &        4.06739585346113531155794489564100469d-2, &
        &        4.06739585346113531155794489564100469d-2, &
        &        3.29863295731734689680165877125236123d-2, &
        &        0.322337890142275510343994470762492129d0, &
        &        0.322337890142275510343994470762492129d0, &
        &        0.322337890142275510343994470762492129d0, &
        &        0.356191386222543912133482341841145015d0, &
        &        0.214602871259152029288839219386285011d0, &
        &        0.214602871259152029288839219386285011d0, &
        &        0.214602871259152029288839219386285011d0, &
        &        0.269672331458315808034097805727606344d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.603005664791649141367431139060939661d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.603005664791649141367431139060939661d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.603005664791649141367431139060939661d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        0.269672331458315808034097805727606344d0, &
        &        0.269672331458315808034097805727606344d0, &
        &        6.36610018750175252992355276057269734d-2, &
        &        6.36610018750175252992355276057269734d-2 /)

        wg_46 = (/ &
        &        4.40444181806813856738716419570572818d-3, &
        &        4.40444181806813856738716419570572818d-3, &
        &        4.40444181806813856738716419570572818d-3, &
        &        4.40444181806813856738716419570572818d-3, &
        &        8.67195792728975545248267625355908457d-3, &
        &        8.67195792728975545248267625355908457d-3, &
        &        8.67195792728975545248267625355908457d-3, &
        &        8.67195792728975545248267625355908457d-3, &
        &        1.25420935892336663012092563878659574d-3, &
        &        1.25420935892336663012092563878659574d-3, &
        &        1.25420935892336663012092563878659574d-3, &
        &        1.25420935892336663012092563878659574d-3, &
        &        6.96063047615581628449647664646860416d-3, &
        &        6.96063047615581628449647664646860416d-3, &
        &        6.96063047615581628449647664646860416d-3, &
        &        6.96063047615581628449647664646860416d-3, &
        &        6.04682171021813716686992035805722311d-3, &
        &        6.04682171021813716686992035805722311d-3, &
        &        6.04682171021813716686992035805722311d-3, &
        &        6.04682171021813716686992035805722311d-3, &
        &        6.04682171021813716686992035805722311d-3, &
        &        6.04682171021813716686992035805722311d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        1.19281714847407219170312687739388419d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3, &
        &        2.57558102516005580225505425429305549d-3 /)
        xg_46 = (/ &
        &        0.107952724962210848482193280727073596d0, &
        &        0.107952724962210848482193280727073596d0, &
        &        0.676141825113367454553420157818779117d0, &
        &        0.107952724962210848482193280727073596d0, &
        &        0.185109487782586570276908000251748098d0, &
        &        0.185109487782586570276908000251748098d0, &
        &        0.444671536652240289169275999244755706d0, &
        &        0.185109487782586570276908000251748098d0, &
        &        4.23165436847672816240820428407247156d-2, &
        &        4.23165436847672816240820428407247156d-2, &
        &        0.873050368945698155127753871477825853d0, &
        &        4.23165436847672816240820428407247156d-2, &
        &        0.314181709124038995363328773438131683d0, &
        &        0.314181709124038995363328773438131683d0, &
        &        5.74548726278830139100136796856049517d-2, &
        &        0.314181709124038995363328773438131683d0, &
        &        0.435591328583830205228133161796597049d0, &
        &        6.44086714161697947718668382034029514d-2, &
        &        0.435591328583830205228133161796597049d0, &
        &        0.435591328583830205228133161796597049d0, &
        &        6.44086714161697947718668382034029514d-2, &
        &        6.44086714161697947718668382034029514d-2, &
        &        0.717464063426308323290028557125581469d0, &
        &        0.717464063426308323290028557125581469d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.239668076319430527020973264027949719d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.239668076319430527020973264027949719d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        2.14339301271305748444990894232344058d-2, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.239668076319430527020973264027949719d0, &
        &        0.717464063426308323290028557125581469d0, &
        &        0.583797378302144405926669754207329982d0, &
        &        0.583797378302144405926669754207329982d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        7.92395394579735321274964823230087451d-3, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        7.92395394579735321274964823230087451d-3, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        7.92395394579735321274964823230087451d-3, &
        &        0.583797378302144405926669754207329982d0 /)
        yg_46 = (/ &
        &        0.107952724962210848482193280727073596d0, &
        &        0.676141825113367454553420157818779117d0, &
        &        0.107952724962210848482193280727073596d0, &
        &        0.107952724962210848482193280727073596d0, &
        &        0.185109487782586570276908000251748098d0, &
        &        0.444671536652240289169275999244755706d0, &
        &        0.185109487782586570276908000251748098d0, &
        &        0.185109487782586570276908000251748098d0, &
        &        4.23165436847672816240820428407247156d-2, &
        &        0.873050368945698155127753871477825853d0, &
        &        4.23165436847672816240820428407247156d-2, &
        &        4.23165436847672816240820428407247156d-2, &
        &        0.314181709124038995363328773438131683d0, &
        &        5.74548726278830139100136796856049517d-2, &
        &        0.314181709124038995363328773438131683d0, &
        &        0.314181709124038995363328773438131683d0, &
        &        6.44086714161697947718668382034029514d-2, &
        &        0.435591328583830205228133161796597049d0, &
        &        0.435591328583830205228133161796597049d0, &
        &        6.44086714161697947718668382034029514d-2, &
        &        0.435591328583830205228133161796597049d0, &
        &        6.44086714161697947718668382034029514d-2, &
        &        2.14339301271305748444990894232344058d-2, &
        &        2.14339301271305748444990894232344058d-2, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.717464063426308323290028557125581469d0, &
        &        0.239668076319430527020973264027949719d0, &
        &        0.717464063426308323290028557125581469d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.239668076319430527020973264027949719d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.717464063426308323290028557125581469d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.239668076319430527020973264027949719d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.583797378302144405926669754207329982d0, &
        &        7.92395394579735321274964823230087451d-3, &
        &        0.583797378302144405926669754207329982d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        7.92395394579735321274964823230087451d-3, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.583797378302144405926669754207329982d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        7.92395394579735321274964823230087451d-3 /)
        zg_46 = (/ &
        &        0.676141825113367454553420157818779117d0, &
        &        0.107952724962210848482193280727073596d0, &
        &        0.107952724962210848482193280727073596d0, &
        &        0.107952724962210848482193280727073596d0, &
        &        0.444671536652240289169275999244755706d0, &
        &        0.185109487782586570276908000251748098d0, &
        &        0.185109487782586570276908000251748098d0, &
        &        0.185109487782586570276908000251748098d0, &
        &        0.873050368945698155127753871477825853d0, &
        &        4.23165436847672816240820428407247156d-2, &
        &        4.23165436847672816240820428407247156d-2, &
        &        4.23165436847672816240820428407247156d-2, &
        &        5.74548726278830139100136796856049517d-2, &
        &        0.314181709124038995363328773438131683d0, &
        &        0.314181709124038995363328773438131683d0, &
        &        0.314181709124038995363328773438131683d0, &
        &        6.44086714161697947718668382034029514d-2, &
        &        6.44086714161697947718668382034029514d-2, &
        &        6.44086714161697947718668382034029514d-2, &
        &        0.435591328583830205228133161796597049d0, &
        &        0.435591328583830205228133161796597049d0, &
        &        0.435591328583830205228133161796597049d0, &
        &        0.239668076319430527020973264027949719d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.717464063426308323290028557125581469d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.717464063426308323290028557125581469d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.717464063426308323290028557125581469d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        0.239668076319430527020973264027949719d0, &
        &        0.239668076319430527020973264027949719d0, &
        &        2.14339301271305748444990894232344058d-2, &
        &        2.14339301271305748444990894232344058d-2, &
        &        7.92395394579735321274964823230087451d-3, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.583797378302144405926669754207329982d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.583797378302144405926669754207329982d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.583797378302144405926669754207329982d0, &
        &        0.204139333876029120430290298780184548d0, &
        &        7.92395394579735321274964823230087451d-3, &
        &        7.92395394579735321274964823230087451d-3, &
        &        0.204139333876029120430290298780184548d0, &
        &        0.204139333876029120430290298780184548d0 /)

        IF (dmngp == 24) THEN
            dmxabsc = xg_24
            dmyabsc = yg_24
            dmzabsc = zg_24
            dmweig  = wg_24
        END IF

        IF (dmngp == 46) THEN
            dmxabsc = xg_46
            dmyabsc = yg_46
            dmzabsc = zg_46
            dmweig  = wg_46
        END IF

    END SUBROUTINE GauLegUniTetCff3D

    SUBROUTINE dEelementVelocity(dmAx, dmAy, dmAz, &
                             &   dmBx, dmBy, dmBz, &
                             &   dmCx, dmCy, dmCz, &
                             &   dmEnx, dmEny, dmEnz, &
                             &   dmPhiA, dmPhiB, dmPhiC, &
                             &   dmPhiNrmlA, &
                             &   dmEu, dmEv, dmEw)

        IMPLICIT NONE

        DOUBLE PRECISION, INTENT(IN) :: dmAx, dmAy, dmAz, &
                                     &  dmBx, dmBy, dmBz, &
                                     &  dmCx, dmCy, dmCz, &
                                     &  dmEnx, dmEny, dmEnz

        DOUBLE PRECISION, INTENT(IN) :: dmPhiA, dmPhiB, dmPhiC, dmPhiNrmlA
        DOUBLE PRECISION, INTENT(OUT):: dmEu, dmEv, dmEw

        DOUBLE PRECISION :: tpMtr11,tpMtr12,tpMtr13,tpMtr21,tpMtr22,tpMtr23,&
                        &   tpMtr31,tpMtr32,tpMtr33,tpMtrdet
        DOUBLE PRECISION :: tpMtr11_1,tpMtr12_1,tpMtr13_1,tpMtr21_1,tpMtr22_1,tpMtr23_1,&
                        &   tpMtr31_1,tpMtr32_1,tpMtr33_1
        DOUBLE PRECISION :: tpcBB1, tpcBB2, tpcBB3

        tpcBB1 = dmPhiA - dmPhiB
        tpcBB2 = dmPhiA - dmPhiC
        tpcBB3 = dmPhiNrmlA

        tpMtr11 = dmAx - dmBx
        tpMtr12 = dmAy - dmBy
        tpMtr13 = dmAz - dmBz
        tpMtr21 = dmAx - dmCx
        tpMtr22 = dmAy - dmCy
        tpMtr23 = dmAz - dmCz
        tpMtr31 = dmEnx
        tpMtr32 = dmEny
        tpMtr33 = dmEnz
        tpMtrdet = tpMtr11*tpMtr22*tpMtr33&
                & +tpMtr21*tpMtr32*tpMtr13&
                & +tpMtr31*tpMtr12*tpMtr23&
                & -tpMtr11*tpMtr32*tpMtr23&
                & -tpMtr31*tpMtr22*tpMtr13&
                & -tpMtr21*tpMtr12*tpMtr33
        tpMtrdet = 1.0d0/tpMtrdet
        tpMtr11_1 = tpMtrdet*(tpMtr22*tpMtr33-tpMtr23*tpMtr32)
        tpMtr12_1 = tpMtrdet*(tpMtr13*tpMtr32-tpMtr12*tpMtr33)
        tpMtr13_1 = tpMtrdet*(tpMtr12*tpMtr23-tpMtr13*tpMtr22)
        tpMtr21_1 = tpMtrdet*(tpMtr23*tpMtr31-tpMtr21*tpMtr33)
        tpMtr22_1 = tpMtrdet*(tpMtr11*tpMtr33-tpMtr13*tpMtr31)
        tpMtr23_1 = tpMtrdet*(tpMtr13*tpMtr21-tpMtr11*tpMtr23)
        tpMtr31_1 = tpMtrdet*(tpMtr21*tpMtr32-tpMtr22*tpMtr31)
        tpMtr32_1 = tpMtrdet*(tpMtr12*tpMtr31-tpMtr11*tpMtr32)
        tpMtr33_1 = tpMtrdet*(tpMtr11*tpMtr22-tpMtr12*tpMtr21)

        dmEu = tpMtr11_1*tpcBB1 + tpMtr12_1*tpcBB2 + tpMtr13_1*tpcBB3
        dmEv = tpMtr21_1*tpcBB1 + tpMtr22_1*tpcBB2 + tpMtr23_1*tpcBB3
        dmEw = tpMtr31_1*tpcBB1 + tpMtr32_1*tpcBB2 + tpMtr33_1*tpcBB3

    END SUBROUTINE



    SUBROUTINE zEelementVelocity(dmAx, dmAy, dmAz, &
                             &   dmBx, dmBy, dmBz, &
                             &   dmCx, dmCy, dmCz, &
                             &   dmEnx, dmEny, dmEnz, &
                             &   dmPhiA, dmPhiB, dmPhiC, &
                             &   dmPhiNrmlA, &
                             &   dmEu, dmEv, dmEw)

        IMPLICIT NONE

        DOUBLE PRECISION, INTENT(IN) :: dmAx, dmAy, dmAz, &
                                     &  dmBx, dmBy, dmBz, &
                                     &  dmCx, dmCy, dmCz, &
                                     &  dmEnx, dmEny, dmEnz

        COMPLEX(KIND=KIND(1.0D0)), INTENT(IN) :: dmPhiA, dmPhiB, dmPhiC, dmPhiNrmlA
        COMPLEX(KIND=KIND(1.0D0)), INTENT(OUT):: dmEu, dmEv, dmEw

        DOUBLE PRECISION :: tpMtr11,tpMtr12,tpMtr13,tpMtr21,tpMtr22,tpMtr23,&
                        &   tpMtr31,tpMtr32,tpMtr33,tpMtrdet
        DOUBLE PRECISION :: tpMtr11_1,tpMtr12_1,tpMtr13_1,tpMtr21_1,tpMtr22_1,tpMtr23_1,&
                        &   tpMtr31_1,tpMtr32_1,tpMtr33_1
        COMPLEX(KIND=KIND(1.0D0)) :: ztpBB1, ztpBB2, ztpBB3

        ztpBB1 = dmPhiA - dmPhiB
        ztpBB2 = dmPhiA - dmPhiC
        ztpBB3 = dmPhiNrmlA

        tpMtr11 = dmAx - dmBx
        tpMtr12 = dmAy - dmBy
        tpMtr13 = dmAz - dmBz
        tpMtr21 = dmAx - dmCx
        tpMtr22 = dmAy - dmCy
        tpMtr23 = dmAz - dmCz
        tpMtr31 = dmEnx
        tpMtr32 = dmEny
        tpMtr33 = dmEnz
        tpMtrdet = tpMtr11*tpMtr22*tpMtr33&
                & +tpMtr21*tpMtr32*tpMtr13&
                & +tpMtr31*tpMtr12*tpMtr23&
                & -tpMtr11*tpMtr32*tpMtr23&
                & -tpMtr31*tpMtr22*tpMtr13&
                & -tpMtr21*tpMtr12*tpMtr33
        tpMtrdet = 1.0d0/tpMtrdet
        tpMtr11_1 = tpMtrdet*(tpMtr22*tpMtr33-tpMtr23*tpMtr32)
        tpMtr12_1 = tpMtrdet*(tpMtr13*tpMtr32-tpMtr12*tpMtr33)
        tpMtr13_1 = tpMtrdet*(tpMtr12*tpMtr23-tpMtr13*tpMtr22)
        tpMtr21_1 = tpMtrdet*(tpMtr23*tpMtr31-tpMtr21*tpMtr33)
        tpMtr22_1 = tpMtrdet*(tpMtr11*tpMtr33-tpMtr13*tpMtr31)
        tpMtr23_1 = tpMtrdet*(tpMtr13*tpMtr21-tpMtr11*tpMtr23)
        tpMtr31_1 = tpMtrdet*(tpMtr21*tpMtr32-tpMtr22*tpMtr31)
        tpMtr32_1 = tpMtrdet*(tpMtr12*tpMtr31-tpMtr11*tpMtr32)
        tpMtr33_1 = tpMtrdet*(tpMtr11*tpMtr22-tpMtr12*tpMtr21)

        dmEu = tpMtr11_1*ztpBB1 + tpMtr12_1*ztpBB2 + tpMtr13_1*ztpBB3
        dmEv = tpMtr21_1*ztpBB1 + tpMtr22_1*ztpBB2 + tpMtr23_1*ztpBB3
        dmEw = tpMtr31_1*ztpBB1 + tpMtr32_1*ztpBB2 + tpMtr33_1*ztpBB3

    END SUBROUTINE

    subroutine test_fdcoef
        implicit none

!tests the finite difference coefficient generator
        integer          ngrid
        parameter        (ngrid=15)
        integer          i
        DOUBLE PRECISION xgrid(ngrid), coef(ngrid), stt

        stt = -7.0d0
        do i = 1, 15
            xgrid(i) = stt + dble(i-1)
        end do

!note the order of derivative is from zeroth order but count from 1 in this code
!aka 1->0th order; 2->1st order and so on === the 1st dummy parameter
!the order of accuracy is in O(h^n) not o(h^n) === the 2nd dummy parameter
!the point at which to evaluate the coefficients === the 3rd dummy parameter
!the range of the grid,
!aka the farest point where the coefficient will be evaluated === the 4th parameter

!central point...
!the first order of derivative with accuracy o(h^14) or O(h^15)
        call fdcoef(2,ngrid,xgrid(8),xgrid(1),coef)

!first point; one sided
        call fdcoef(2,ngrid,xgrid(1),xgrid(1),coef)


!second point; one sided
        call fdcoef(2,ngrid,xgrid(2),xgrid(1),coef)

!middle of the grid
        do i=3,ngrid-2
            call fdcoef(2,ngrid,xgrid(i),xgrid(i-2),coef)
        enddo

!second to last point; one sided
        call fdcoef(2,ngrid,xgrid(ngrid-1),xgrid(ngrid-4),coef)

!last point; one sided
        call fdcoef(2,ngrid,xgrid(ngrid),xgrid(ngrid-4),coef)

    end



    subroutine fdcoef(mord,nord,x0,grid,coef)
        implicit none
        save

!this routine implements simple recursions for calculating the weights
!of finite difference formulas for any order of derivative and any order
!of accuracy on one-dimensional grids with arbitrary spacing.

!from bengt fornberg's article
!generation of finite difference formulas on arbitrary spaced grids.
!math. comp., 51(184):699-706, 1988.


!input:
!mord       = the order of the derivative
!nord       = order of accuracy n
!x0         = point at which to evaluate the coefficients
!grid(nord) = array containing the grid

!output:
!coef(nord) = coefficients of the finite difference formula.


!declare the pass
        integer          mord,nord
        DOUBLE PRECISION x0,grid(nord),coef(nord)


!local variables
        integer          nu,nn,mm,nmmin,mmax,nmax
        parameter        (mmax=8, nmax=20)
        DOUBLE PRECISION weight(mmax,nmax,nmax),c1,c2,c3,c4,pfac


!zero the weight array
        do nu=1,nord
            do nn=1,nord
                do mm=1,mord
                    weight(mm,nn,nu) = 0.0d0
                enddo
            enddo
        enddo

        weight(1,1,1) = 1.0d0
        c1            = 1.0d0
        nmmin         = min(nord,mord)
        do nn = 2,nord
            c2 = 1.0d0
            do nu=1,nn-1
                c3 = grid(nn) - grid(nu)
                c2 = c2 * c3
                c4 = 1.0d0/c3
                pfac = grid(nn) - x0
                weight(1,nn,nu) = c4 * ( pfac * weight(1,nn-1,nu) )
                do mm=2,nmmin
                    weight(mm,nn,nu) = c4 * ( pfac * weight(mm,nn-1,nu) &
                    &                 - dfloat(mm-1)*weight(mm-1,nn-1,nu) )
                enddo
            enddo
            pfac = (grid(nn-1) - x0)
            weight(1,nn,nn) = c1/c2 * (-pfac*weight(1,nn-1,nn-1))
            c4 = c1/c2
            do mm=2,nmmin
                weight(mm,nn,nn) = c4 * (dfloat(mm-1)*weight(mm-1,nn-1,nn-1) - &
                &                  pfac*weight(mm,nn-1,nn-1))
            enddo
            c1 = c2
        enddo

!load the coefficients
        do nu = 1,nord
            coef(nu) = weight(mord,nord,nu)
        enddo
        return

    end
